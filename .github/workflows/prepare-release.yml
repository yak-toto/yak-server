name: üìù Prepare Release

on:
  workflow_dispatch:
    inputs:
      release-type:
        type: choice
        description: Release type
        options:
          - patch
          - minor
          - major

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  prepare:
    name: Prepare Release PR
    runs-on: ubuntu-latest

    permissions:
      contents: write # <-- Enables creating branches
      pull-requests: write # <-- Enables creating PRs

    env:
      python-version: "3.13"

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Install uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
        with:
          python-version: ${{ env.python-version }}
          enable-cache: false

      - name: Create version bump commit
        id: version-bump
        run: |
          git config user.name 'yak-toto'
          git config user.email 'yaktoto648@gmail.com'

          # Bump version
          uv version --bump "${GITHUB_EVENT_INPUTS_RELEASE_TYPE}"
          NEW_VERSION=$(uv version --short)

          # Update lock file
          uv lock

          # Create branch and commit
          BRANCH_NAME="release/v${NEW_VERSION}"
          git checkout -b "${BRANCH_NAME}"
          git add pyproject.toml uv.lock
          git commit -m "Release ${NEW_VERSION}"

          # Create annotated tag
          git tag -a "${NEW_VERSION}" HEAD -m "${NEW_VERSION}"

          echo "new-version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"
          echo "branch-name=${BRANCH_NAME}" >> "$GITHUB_OUTPUT"
        env:
          GITHUB_EVENT_INPUTS_RELEASE_TYPE: ${{ github.event.inputs.release-type }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@0979079bc20c05bbbb590a56c21c4e2b1d1f1bbe
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.version-bump.outputs.branch-name }}
          base: main
          title: "Release ${{ steps.version-bump.outputs.new-version }}"
          body: |
            ## üöÄ Release ${{ steps.version-bump.outputs.new-version }}

            This PR prepares the release for version ${{ steps.version-bump.outputs.new-version }}.

            ### Changes
            - Bumped version in `pyproject.toml`
            - Updated `uv.lock`
            - Created tag `${{ steps.version-bump.outputs.new-version }}`

            ### Next Steps
            1. Review the changes
            2. Merge this PR to `main`
            3. The release will be **automatically published to PyPI** when this PR is merged

            ---
            *This PR was automatically created by the Prepare Release workflow.*
          labels: release
